<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Διαχείριση Διπλωματικής</title>
<style>
body{font-family:Arial; max-width:800px; margin:auto; padding:1rem;}
h2{text-align:center;}
table{width:100%; border-collapse:collapse; margin-top:1rem;}
th,td{border:1px solid #ccc; padding:0.5rem; text-align:left;}
button{margin-top:0.5rem; padding:0.5rem;}
input[type=text]{width:100%;}
</style>
</head>
<body>
<h2>Διαχείριση Διπλωματικής</h2>

<div id="thesisInfo"></div>

<script>
function fetchThesis(){
    fetch('../../api/student/get_student_thesis.php')
    .then(res=>res.json())
    .then(data=>{
        if(!data.success){ document.getElementById('thesisInfo').innerText=data.message; return; }
        const t = data.thesis;
        let html = `
        <table>
        <tr><th>Θέμα</th><td>${t.title}</td></tr>
        <tr><th>Περιγραφή</th><td>${t.summary}</td></tr>
        <tr><th>PDF</th><td><a href="${t.pdf_path}" target="_blank">Άνοιγμα PDF</a></td></tr>
        <tr><th>Κατάσταση</th><td>${t.status}</td></tr>
        <tr><th>Ημερομηνία Ανάθεσης</th><td>${t.assignment_date}</td></tr>
        <tr><th>Επιβλέπων</th><td>${t.supervisor_first} ${t.supervisor_last}</td></tr>
        <tr><th>Μέλη Επιτροπής</th><td>${t.committee_members.map(m=>m.first_name+" "+m.last_name+" ("+m.status+")").join("<br>")}</td></tr>
        </table>
        `;

        if(t.status==='under_review'){
            html += `<h3>Καταχώρηση Συνδέσμου Νημερτής</h3>
            <input type="text" id="library_link" placeholder="https://...">
            <button onclick="saveLibraryLink(${t.thesis_id})">Αποθήκευση</button>
            <h3>Ανέβασμα Προσχεδίου</h3>
            <input type="file" id="review_doc">
            <button onclick="uploadReview(${t.thesis_id})">Ανέβασμα</button>
            `;
        }

        document.getElementById('thesisInfo').innerHTML = html;
    });
}

function saveLibraryLink(thesis_id){
    const link = document.getElementById('library_link').value;
    fetch('../../api/student/update_library_link.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({thesis_id, library_link: link})
    }).then(res=>res.json()).then(data=>{
        alert(data.message);
        fetchThesis();
    });
}

function uploadReview(thesis_id){
    const fileInput = document.getElementById('review_doc');
    if(fileInput.files.length===0){ alert("Επιλέξτε αρχείο"); return; }
    const formData = new FormData();
    formData.append('thesis_id', thesis_id);
    formData.append('review_doc', fileInput.files[0]);

    fetch('../../api/student/upload_review_doc.php',{
        method:'POST',
        body: formData
    }).then(res=>res.json()).then(data=>{
        alert(data.message);
        fetchThesis();
    });
}

fetchThesis();
</script>
</body>
</html>
