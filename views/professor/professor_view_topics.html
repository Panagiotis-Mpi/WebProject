<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Τα Θέματά μου</title>
<link rel="stylesheet" href="../../assets/css/professor/professor_view_topics.css">
</head>
<body>

<header>
    <img src="../../assets/img/ceid.png" alt="CEID Logo" class="logo">
    <h1>Τα Θέματά μου</h1>
    <button class="logout-btn" onclick="logout()">Αποσύνδεση</button>
</header>

<main>
    <div class="container">
        <div id="topics-list">Φόρτωση θεμάτων...</div>

        <div id="modal-overlay"></div>

        <div id="topic-modal" class="hidden">
            <h2>Λεπτομέρειες Θέματος</h2>
            <form id="topic-form">
                <input type="hidden" id="topic-id">
                <label>Τίτλος:</label>
                <input type="text" id="topic-title" required>
                <label>Περίληψη:</label>
                <textarea id="topic-summary" rows="8" required></textarea>
                <label>PDF:</label>
                <input type="text" id="topic-pdf">
                <div id="pdf-viewer" style="margin-top:5px;"></div>
                <div class="modal-buttons">
                    <button type="submit">Αποθήκευση Αλλαγών</button>
                    <button type="button" id="close-modal">Κλείσιμο</button>
                </div>
            </form>
        </div>

        <button class="back-btn" onclick="window.location.href='professor_dashboard.html'">Πίσω</button>
    </div>
</main>

<footer>
    <p>&copy; 2025 Πανεπιστήμιο Πατρών - Πλατφόρμα Διπλωματικών - Τμήμα Μηχανικών Η/Υ & Πληροφορικής</p>
</footer>

<script>
function logout(){
    fetch('../../api/auth/logout.php')
        .then(() => window.location.href = '../auth/login.html');
}

document.addEventListener('DOMContentLoaded', () => {
    const topicsList = document.getElementById('topics-list');
    const modal = document.getElementById('topic-modal');
    const overlay = document.getElementById('modal-overlay');
    const topicForm = document.getElementById('topic-form');

    fetch('../../api/professor/get_professor_topics.php')
    .then(res => res.json())
    .then(data => {
        if(data.success){
            topicsList.innerHTML = '';
            data.topics.forEach(topic => {
                const studentName = topic.student_first ? topic.student_first + ' ' + topic.student_last : null;
                const committeeText = topic.committee.length ? topic.committee.map(m => `${m.first_name} ${m.last_name} (${m.status})`).join(', ') : null;

                const pdfLink = topic.pdf_path ? `<a href="${topic.pdf_path}" target="_blank">Προβολή PDF</a>` : 'Χωρίς PDF';

                const div = document.createElement('div');
                div.classList.add('topic-item');
                div.innerHTML = `
                    <strong>${topic.title}</strong><br>
                    Φοιτητής: ${studentName || 'Δεν έχει ανατεθεί'}<br>
                    Κατάσταση Διπλωματικής: ${topic.thesis_status || 'Δεν έχει ανατεθεί'}<br>
                    Τριμελής Επιτροπή: ${committeeText || 'Δεν έχει οριστεί'}<br>
                    PDF: ${pdfLink}
                `;

                div.dataset.id = topic.id;
                div.dataset.title = topic.title;
                div.dataset.summary = topic.summary;
                div.dataset.pdf = topic.pdf_path;

                div.addEventListener('click', () => openModal(div));
                topicsList.appendChild(div);
            });
        } else {
            topicsList.textContent = 'Σφάλμα φόρτωσης θεμάτων';
        }
    });

    function openModal(div){
        document.getElementById('topic-id').value = div.dataset.id;
        document.getElementById('topic-title').value = div.dataset.title;
        document.getElementById('topic-summary').value = div.dataset.summary;
        document.getElementById('topic-pdf').value = div.dataset.pdf;

        // Προβολή link PDF στο modal
        const pdfViewer = document.getElementById('pdf-viewer');
        if(div.dataset.pdf){
            pdfViewer.innerHTML = `<a href="${div.dataset.pdf}" target="_blank">Άνοιγμα PDF</a>`;
        } else {
            pdfViewer.innerHTML = 'Χωρίς PDF';
        }

        modal.classList.remove('hidden');
        overlay.style.display = 'block';
    }

    document.getElementById('close-modal').addEventListener('click', () => {
        modal.classList.add('hidden');
        overlay.style.display = 'none';
    });

    topicForm.addEventListener('submit', e => {
        e.preventDefault();
        const topicId = document.getElementById('topic-id').value;
        const title = document.getElementById('topic-title').value;
        const summary = document.getElementById('topic-summary').value;
        const pdf = document.getElementById('topic-pdf').value;

        fetch('../../api/professor/update_topic.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id: topicId, title, summary, pdf})
        })
        .then(res => res.json())
        .then(resp => {
            if(resp.success){
                alert('Το θέμα ενημερώθηκε επιτυχώς!');
                modal.classList.add('hidden');
                overlay.style.display = 'none';
                location.reload();
            } else {
                alert('Σφάλμα κατά την ενημέρωση: ' + resp.message);
            }
        });
    });
});
</script>
</body>
</html>
