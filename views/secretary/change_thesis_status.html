<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Αλλαγή Κατάστασης Διπλωματικής</title>
<style>
body { font-family: Arial; max-width: 600px; margin: auto; padding: 1rem; }
select, input, button { margin-top: 1rem; width: 100%; padding: 0.5rem; }
#message { margin-top: 1rem; font-weight: bold; }
</style>
</head>
<body>
<h2>Αλλαγή Κατάστασης Διπλωματικής</h2>

<label>Επιλέξτε Διπλωματική:</label>
<select id="thesisSelect"></select>

<div id="actions"></div>

<div id="message"></div>

<button onclick="window.location.href='secretary_dashboard.html'">Επιστροφή στο Dashboard</button>

<script>
async function loadTheses(){
    const res = await fetch('../../api/secretary/get_active_underreview_theses.php');
    const data = await res.json();
    const select = document.getElementById('thesisSelect');
    select.innerHTML = '';
    data.theses.forEach(thesis => {
        const option = document.createElement('option');
        option.value = thesis.id;
        option.textContent = thesis.title + " (" + thesis.status + ")";
        select.appendChild(option);
    });
    showActions();
}

function showActions(){
    const thesisId = document.getElementById('thesisSelect').value;
    const thesis = thesisData.find(t => t.id == thesisId);
    const actionsDiv = document.getElementById('actions');
    actionsDiv.innerHTML = '';

    if(thesis.status === 'active'){
        actionsDiv.innerHTML = `
            <input type="text" id="gs_protocol" placeholder="Αριθμός Πρακτικού ΓΣ">
            <input type="text" id="cancel_reason" placeholder="Λόγος Ακύρωσης (προαιρετικό)">
            <button onclick="changeStatus('under_review')">Καταχώρηση Πρακτικού</button>
            <button onclick="changeStatus('cancelled')">Ακύρωση ΔΕ</button>
        `;
    } else if(thesis.status === 'under_review'){
        actionsDiv.innerHTML = `
            <button onclick="changeStatus('completed')">Ολοκλήρωση ΔΕ (Περατωμένη)</button>
        `;
    }
}

async function changeStatus(newStatus){
    const thesisId = document.getElementById('thesisSelect').value;
    const gs_protocol = document.getElementById('gs_protocol') ? document.getElementById('gs_protocol').value : null;
    const cancel_reason = document.getElementById('cancel_reason') ? document.getElementById('cancel_reason').value : null;

    const res = await fetch('../../api/secretary/change_thesis_status.php',{
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({thesis_id: thesisId, status: newStatus, gs_protocol, cancel_reason})
    });
    const data = await res.json();
    const msg = document.getElementById('message');
    msg.textContent = data.message;
    msg.style.color = data.success ? 'green' : 'red';
    loadTheses();
}

// Προφόρτωση δεδομένων
let thesisData = [];
loadTheses();
</script>
</body>
</html>
