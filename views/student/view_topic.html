<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Προβολή Θέματος</title>
<link rel="stylesheet" href="../../assets/css/student/view_topic.css">
</head>
<body>

<header>
    <img src="../../assets/img/ceid.png" alt="CEID Logo" class="logo">
    <h1>Προβολή Θέματος</h1>
    <button class="logout-btn" onclick="logout()">Αποσύνδεση</button>
</header>

<main>
    <div class="container" id="topicDetails">Φόρτωση...</div>
    <button class="back-btn" onclick="window.location.href='student_dashboard.html'">Πίσω</button>
</main>

<footer>
    <p>&copy; 2025 Πανεπιστήμιο Πατρών - Πλατφόρμα Διπλωματικών - Τμήμα Μηχανικών Η/Υ & Πληροφορικής</p>
</footer>

<script>
function logout(){
    fetch('../../api/auth/logout.php')
        .then(res => res.json())
        .then(data => {
            if(data.success) window.location.href='../auth/login.html';
            else alert('Σφάλμα κατά την αποσύνδεση');
        })
        .catch(() => alert('Σφάλμα επικοινωνίας με τον server'));
}

// Φόρτωση δεδομένων θέματος
fetch('../../api/student/get_student_topic.php')
.then(res => res.json())
.then(data => {
    const div = document.getElementById('topicDetails');
    if(!data.success){
        div.innerHTML = "<p style='color:red'>" + data.message + "</p>";
        return;
    }

    let html = `
        <h2>${data.topic.title}</h2>
        <p><strong>Περιγραφή:</strong> ${data.topic.summary}</p>
    `;

    if(data.topic.pdf_path){
        html += `<p><strong>Αρχείο PDF:</strong> <a href="${data.topic.pdf_path}" target="_blank">Προβολή PDF</a></p>`;
    }

    if(data.thesis){
        html += `<p><strong>Κατάσταση Διπλωματικής:</strong> ${data.thesis.status}</p>`;
        if(data.thesis.assignment_date){
            html += `<p><strong>Ημέρες από ανάθεση:</strong> ${data.days_since_assignment} ημέρες</p>`;
        }
        if(data.thesis.review_doc_path){
            html += `<p><strong>Οι σημειώσεις σας: </strong> <a href="../../uploads/student_docs/${data.thesis.review_doc_path}" target="_blank">Προβολή PDF</a></p>`;
        }
    }

    if(data.committee && data.committee.length > 0){
        html += "<h3>Τριμελής Επιτροπή</h3><ul>";
        data.committee.forEach(m => {
            html += `<li>${m.first_name} ${m.last_name} (${m.role}, ${m.status})</li>`;
        });
        html += "</ul>";
    }

    // Περιοχή ανέβασμα PDF
    html += `
    <div class="upload-section">
        <h3>Ανέβασμα PDF - Σημειώσεων</h3>
        <input type="file" id="studentPdf" accept="application/pdf">
        <button id="uploadBtn">Ανέβασμα</button>
        <p id="uploadMessage" style="color:green;"></p>
    </div>
    `;

    div.innerHTML = html;

    // Κουμπί ανέβασμα PDF
    document.getElementById('uploadBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('studentPdf');
        const file = fileInput.files[0];
        const msg = document.getElementById('uploadMessage');

        if(!file){
            alert('Επιλέξτε ένα PDF αρχείο!');
            return;
        }

        const formData = new FormData();
        formData.append('pdf', file);

        fetch('../../api/student/upload_student_pdf.php', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                msg.style.color = 'green';
                msg.textContent = 'Το PDF ανέβηκε με επιτυχία!';
            } else {
                msg.style.color = 'red';
                msg.textContent = 'Σφάλμα: ' + data.message;
            }
        })
        .catch(() => {
            msg.style.color = 'red';
            msg.textContent = 'Σφάλμα κατά την επικοινωνία με τον server.';
        });
    });
})
.catch(err=>{
    document.getElementById('topicDetails').innerHTML = "<p style='color:red'>Σφάλμα φόρτωσης.</p>";
});
</script>
</body>
</html>
