<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Διαχείριση Διπλωματικής</title>
<style>
body{font-family:Arial; max-width:800px; margin:auto; padding:1rem;}
h2,h3{text-align:center;}
section{margin-bottom:2rem; padding:1rem; border:1px solid #ccc; border-radius:8px;}
button{padding:0.5rem; margin-top:0.5rem; border-radius:5px; cursor:pointer;}
table{width:100%; border-collapse:collapse; margin-top:1rem;}
th,td{border:1px solid #ccc; padding:0.5rem; text-align:left;}
input,select{padding:0.3rem; width:95%;}
#message{margin-top:1rem; font-weight:bold;}
</style>
</head>
<body>

<h2>Διαχείριση Διπλωματικής Εργασίας</h2>
<div id="message"></div>

<section id="thesisInfo"></section>

<section id="inviteSection"></section>
<section id="underReviewSection"></section>
<section id="completedSection"></section>

<button onclick="logout()">Αποσύνδεση</button>

<script>
// =====================
// Helper
// =====================
function logout(){
    fetch('../../api/logout.php').then(()=>window.location.href='../login.html');
}

// =====================
// Fetch Thesis
// =====================
function fetchThesis(){
    fetch('../../api/student/get_student_thesis.php')
    .then(res=>res.json())
    .then(data=>{
        const msgDiv = document.getElementById('message');
        if(!data.success){
            msgDiv.textContent = data.message;
            msgDiv.style.color="red";
            return;
        }

        const t = data.thesis;
        msgDiv.textContent = "";
        renderThesisInfo(t);

        if(t.status==='pending') renderInviteSection(t);
        if(t.status==='under_review') renderUnderReviewSection(t);
        if(t.status==='completed') renderCompletedSection(t);
    });
}

// =====================
// Thesis Info
// =====================
function renderThesisInfo(t){
    let html = `<h3>Πληροφορίες Διπλωματικής</h3>
    <p><strong>Θέμα:</strong> ${t.topic_title}</p>
    <p><strong>Περιγραφή:</strong> ${t.topic_summary}</p>
    ${t.topic_pdf_path? `<p><a href="${t.topic_pdf_path}" target="_blank">Συνημμένο PDF</a></p>` : ''}
    <p><strong>Κατάσταση:</strong> ${t.status}</p>
    <p><strong>Χρόνος από ανάθεση:</strong> ${t.assignment_date ? getDaysSince(t.assignment_date) : 'Μη ανατεθεί ακόμα'}</p>
    <p><strong>Μέλη Επιτροπής:</strong> ${t.committee_members.map(m=>`${m.first_name} ${m.last_name} (${m.status})`).join(', ') || 'Μη ορισμένα'}</p>`;
    document.getElementById('thesisInfo').innerHTML = html;
}

function getDaysSince(dateStr){
    const assigned = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now-assigned)/(1000*60*60*24));
    return diff + " ημέρες";
}

// =====================
// Υπό Ανάθεση
// =====================
function renderInviteSection(t){
    fetch('../../api/student/get_professors.php')
    .then(res=>res.json())
    .then(data=>{
        if(!data.success) return;

        let html = `<h3>Πρόσκληση Καθηγητών (Υπό Ανάθεση)</h3>
        <select id="professor_select">
            ${data.professors.map(p=>`<option value="${p.id}">${p.first_name} ${p.last_name}</option>`).join('')}
        </select>
        <button onclick="inviteProfessor(${t.thesis_id})">Προσθήκη</button>
        <div id="currentInvites"><strong>Τρέχουσες προσκλήσεις:</strong>
            <ul>
            ${t.committee_members.map(m=>`<li>${m.first_name} ${m.last_name} (${m.status})</li>`).join('')}
            </ul>
        </div>`;
        document.getElementById('inviteSection').innerHTML = html;
    });
}

function inviteProfessor(thesis_id){
    const professor_id = document.getElementById('professor_select').value;
    fetch('../../api/student/invite_professor.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({thesis_id, professor_id})
    })
    .then(res=>res.json())
    .then(data=>{
        alert(data.message);
        fetchThesis();
    });
}

// =====================
// Υπό Εξέταση
// =====================
function renderUnderReviewSection(t){
    let html = `<h3>Υπό Εξέταση</h3>
    <label>Ανέβασμα αρχείου πρόχειρου κειμένου:</label>
    <input type="file" id="draftFile"><button onclick="uploadDraft(${t.thesis_id})">Ανέβασμα</button>
    <label>Σύνδεσμοι υλικού (URL):</label>
    <input type="text" id="materialLink"><button onclick="addMaterial(${t.thesis_id})">Προσθήκη</button>
    <label>Ημερομηνία & Ώρα παρουσίασης:</label>
    <input type="date" id="presentationDate"><input type="time" id="presentationTime">
    <select id="presentationMode">
        <option value="in_person">Δια ζώσης</option>
        <option value="online">Online</option>
    </select>
    <input type="text" id="presentationLocation" placeholder="Αίθουσα ή σύνδεσμος"><button onclick="addPresentation(${t.thesis_id})">Αποθήκευση παρουσίασης</button>`;
    document.getElementById('underReviewSection').innerHTML = html;
}

// --------------------
// Υπολειπόμενες AJAX functions (uploadDraft, addMaterial, addPresentation)
// --------------------
function uploadDraft(thesis_id){
    const fileInput = document.getElementById('draftFile');
    if(fileInput.files.length===0){ alert("Επιλέξτε αρχείο"); return; }
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('thesis_id', thesis_id);

    fetch('../../api/student/upload_draft.php',{method:'POST', body: formData})
    .then(res=>res.json())
    .then(data=>{ alert(data.message); fetchThesis(); });
}

function addMaterial(thesis_id){
    const link = document.getElementById('materialLink').value;
    if(!link){ alert("Εισάγετε σύνδεσμο"); return; }
    fetch('../../api/student/add_material.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({thesis_id, link})
    }).then(res=>res.json())
    .then(data=>{ alert(data.message); fetchThesis(); });
}

function addPresentation(thesis_id){
    const date = document.getElementById('presentationDate').value;
    const time = document.getElementById('presentationTime').value;
    const mode = document.getElementById('presentationMode').value;
    const location = document.getElementById('presentationLocation').value;

    if(!date || !time || !location){ alert("Συμπληρώστε όλα τα πεδία"); return; }

    fetch('../../api/student/add_presentation.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({thesis_id,date,time,mode,location})
    }).then(res=>res.json())
    .then(data=>{ alert(data.message); fetchThesis(); });
}

// =====================
// Περατωμένη
// =====================
function renderCompletedSection(t){
    let html = `<h3>Περατωμένη</h3>
    <p>Η Διπλωματική έχει ολοκληρωθεί. Προβολή πληροφοριών μόνο.</p>`;
    document.getElementById('completedSection').innerHTML = html;
}

// =====================
// Init
// =====================
fetchThesis();
</script>
</body>
</html>

